<!DOCTYPE html>
<html>
<head>
    <title>Axie Map</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="/axie/js/utils.js"></script>
<script src="/axie/js/landUtils.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js" integrity="sha384-xrRywqdh3PHs8keKZN+8zzc5TX0GRTLCcmivcbNJWm2rs5C8PRhcEn3czEjhAO9o" crossorigin="anonymous"></script>
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<style>
.axieMap img{width:1200px;height:1200px;position:absolute;}
.plot{width:4px; height:4px;position:absolute;display:none; z-index:100;background:#90610c}
.plot2{width:4px; height:4px;position:absolute;display:none; z-index:100;background:#5c1cd9}
.plot3{width:4px; height:4px;position:absolute;display:none; z-index:100;background:#1cd99c}
.pointer{cursor: pointer;}
.plot-wraper{position:relative; width:4px; height:4px; left:600px; top:600px;}
.xy{padding:10px;}
.blink {
  animation: blink-animation 1s steps(5, start) infinite;
  -webkit-animation: blink-animation 1s steps(5, start) infinite;
}
@keyframes blink-animation {
  to {
    visibility: hidden;
  }
}
@-webkit-keyframes blink-animation {
  to {
    visibility: hidden;
  }
}
</style>

</head>
<body >
<div class="xy">
    <form>
        <input placeholder="X cords" id="x" name="x" />
        <input placeholder="Y cords" id="y" name="y"/>
        <input placeholder="ETH Addr/Account ID" id="accountId" name="accountId"/>
        <input placeholder="ETH Addr/Account ID2" id="accountId2" name="accountId2"/>
        <input type="submit" value="go" id="Go" />
    </form>
</div>
<div class="axieMap">
<img src="/axie/images/lunacia_map.png"></img>
<div class="plot-wraper" id="map">
<!--<div class="plot blink"></div>-->

</div>
</div>

<script>

function makeSpot(x, y, cls, price) {
    plotx = x*4 - 1;
    ploty = y*4 - 2;
    let tip = x + ", " + y;
    if (price) {
        tip += "<br>" + Number((parseFloat(price)/1e18).toFixed(3)) + " ETH";
    }

    let spot = $("<div/>", {class: cls, title: tip, "data-toggle": "tooltip", "data-html": "true"});
    spot.css({ top: ploty });
    spot.css({ left: plotx });;
    spot.css({"display" : "block" } );
    $("#map").append(spot);
    return spot;
}

function plot(x, y) {
    makeSpot(x, y, "plot blink");
}

allItems = {};

async function getLandsByAccountId(accountId) {
    r = await fetch("https://axieinfinity.com/land-api/profile/land/" + accountId);
    lands = await r.json();
    return lands;
}

async function getLandsByETHAddr(address) {
    r = await fetch("https://axieinfinity.com/land-api/profile/" + address + "/land");
    lands = await r.json();
    return lands;
}


function plotAddr(lands, style="plot2") {
    for (let i in lands) {
        let x = lands[i].col;
        let y = lands[i].row;
        makeSpot(x, y, style);
    }
}

function plotSales() {
    for (let i in allItems) {
        let land = allItems[i];
        let x = land.col;
        let y = land.row;
        let spot = makeSpot(x, y, "plot pointer", land.currentPrice);
        let url = "https://land.axieinfinity.com/land/" + land.col + "/" + land.row;
        spot.on("click", () => {
            window.open(url, "_blank");
        });
    }
}

async function doAccount(accountParam, style="plot2") {
    let raw = getQueryParameter(accountParam).trim();
    var account = parseInt(raw);
    if (account) {
        let lands;
        if (raw.startsWith("0x")) {
            $("#" + accountParam).val(raw);
            lands = await getLandsByETHAddr(raw);
        } else {
            $("#" + accountParam).val(account);
            lands = await getLandsByAccountId(account);
        }
        plotAddr(lands, style);
    }
}

$( document ).ready(async function() {
    x = parseInt(getQueryParameter("x"));
    y = parseInt(getQueryParameter("y"));
    if (x && y) {
        $("#x").val(x);
        $("#y").val(y);
        plot(x, y);
    } else {
        await getItems();
        plotSales();
    }
    await doAccount("accountId");
    await doAccount("accountId2", "plot3");
    $('[data-toggle="tooltip"]').tooltip();
});
</script>

</body>
</html>