<html>
    <head>
        <title>Axie Gene Explorer</title>
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116189657-1"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-116189657-1');
        </script>
        <!--web3 v0.20.6-->
        <script src="/js/web3.min.js" integrity="sha384-rXHfd7f1o1jpr3t+dYI17CkzUY3Wswo1OGbiXPGSbg4s2E42+jkRgllwt7ss2Vlq"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js" integrity="sha384-r3v0/sXe5ocDydKBFcxP390rex2dEm9qN3Yv68S6uNX/F3b/RtMdGMUADZ8tabkz" crossorigin="anonymous"></script>
        <script src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js" integrity="sha384-zOjU8Lmrn7aY/0op2Zr4DRXhg0el3XJ4SEMVakZ7bni+KP5F9geHOJ0cWYSvj0HN" crossorigin="anonymous"></script>
        <script src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js" integrity="sha384-EzXZHFRG/n4Omd1nQTNbrErjupvcy1TetvtLCAR9wX6U7/CnXYYe8Ea6l6n1KtM5" crossorigin="anonymous"></script>
        <script src="traitmapping.js"></script>
        <script src="js/utils.js"></script>
        <script src="js/geneTable.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css" integrity="sha384-1UXhfqyOyO+W+XsGhiIFwwD3hsaHRz2XDGMle3b8bXPH5+cMsXVShDoHA3AH/y/p" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" integrity="sha384-4zgE69bwrfaNYUZPA2TaKwT/mjqMcBEvQmjHf1qkjg3c2JSWfEGflXXz6xXBLGGN" crossorigin="anonymous">
        <style>
            body {background-color: #efefef;}
        </style>
        <link rel="stylesheet" href="css/axie.css">
    </head>
<script>
    var axies = {};
    var checkedAddresses = [];
    function getAxies(offset, address) {
        let url = "https://axieinfinity.com/api/addresses/" + address + "/axies?offset=" + offset;

        var numSkipped = 0;
        $.get(url, function(data, status, xhr) {
            let percentage = (offset + 12)/data.totalAxies * 100;
            $("#loading").text("Loading..." + Math.round(percentage) + "%");
            for (let i in data.axies) {
                if (data.axies[i].stage < 3) {
                    numSkipped++;
                    continue;
                }
                axies[data.axies[i].id] = {"id": data.axies[i].id, "genes": genesToBin(new BigNumber(data.axies[i].genes)), "owner": data.axies[i].owner, "class": data.class, "exp": data.axies[i].exp};
                addRow(axies[data.axies[i].id]);
            }
            let totalAxies = data.totalAxies;
            if (totalAxies > 12) {
                for (let i = 12; i < totalAxies; i+=12) {
                    let url = "https://axieinfinity.com/api/addresses/" + address + "/axies?offset=" + i;
                    $.get(url, function(data, status, xhr) {
                        let percentage = Object.keys(axies).length/data.totalAxies * 100;
                        $("#loading").text("Loading..." + Math.round(percentage) + "%");
                        for (let i in data.axies) {
                            if (data.axies[i].stage < 3) {
                                numSkipped++;
                                continue;
                            }
                            axies[data.axies[i].id] = {"id": data.axies[i].id, "genes": genesToBin(new BigNumber(data.axies[i].genes)), "owner": data.axies[i].owner, "class": data.class, "exp": data.axies[i].exp};
                            addRow(axies[data.axies[i].id]);
                        }
                        if (Object.keys(axies).length + numSkipped >= totalAxies) { //fudge incase over for some reason
                            $("#loading").text("Done.")
                            $("#loading").fadeOut(3500);
                        }
                    });
                }
            } else {
                $("#loading").text("Done.")
                $("#loading").fadeOut(3500);
            }
        });
    }

    function getAxie(id) {
        $.get("https://axieinfinity.com/api/axies/" + parseInt(id), function(data, status, xhr) {
            if (data.stage < 3) {
                return;
            }
            axies[data.id] = {"id": data.id, "genes": genesToBin(new BigNumber(data.genes)), "owner": data.owner, "class": data.class, "exp": data.exp};
            addRow(axies[data.id]);
        });
    }

    var intID;
    function init() {
        clearInterval(intID);
        $.ajax({
            url: "../header.html",
            cache: false,
            dataType: "html",
            success: function(data) {
                $("#headerDiv").html(data);

                if (typeof web3 == 'undefined') {
                    $("#account").text("Web3 enabled browser not detected. Use the search box.");
                    return;
                } else {
                    if (typeof web3.eth.accounts[0] == "undefined") {
                        $("#account").text("Can't detect your account. Unlock your wallet or try reloading the page and waiting a few seconds.");
                        return;
                    } else {
                        initTable();
                        $("#account").text("Your Account: " + web3.eth.accounts[0]);
                        getAxies(0, web3.eth.accounts[0]);
                    }
                }
            }
        });
    }

    var traitMapping = binarytraits;
    var BigNumber;
    window.addEventListener('load', async () => {
        // Modern dapp browsers...
        if (window.ethereum) {
            window.web3 = new Web3(ethereum);
            BigNumber = web3.BigNumber;
            try {
                // Request account access if needed
                await ethereum.enable();
                console.log("modern dapp browser");
            } catch (error) {
                // User denied account access...
                console.log("User denied ethereum account access.")
            }
        }
        // Legacy dapp browsers...
        else if (window.web3) {
            window.web3 = new Web3(web3.currentProvider);
            BigNumber = web3.BigNumber;
            // Acccounts always exposed
            console.log("legacy dapp browser");
        }
        // Non-dapp browsers...
        else {
            console.log('Non-Ethereum browser detected.');
            //since we are using our own web3.min.js
            let w3 = new Web3();
            BigNumber = w3.BigNumber;
        }
        //defer init until accounts are loaded
        intID = setInterval(init, 250);
    });

    function addSinglesAxie(ids) {
        for (let i in ids) {
            getAxie(ids[i]);
        }
    }

    function search() {
        $("#loading").text("");
        $("#loading").show();
        let text = $("#search").val().trim();
        if (axieTable) {
            axieTable.clear();
            axieTable.draw();
        }
        if (text.includes(",")) {
            let splits = text.split(/\s*,\s*/);
            let addresses = [];
            let ids = [];
            for (let i in splits) {
                if (splits[i] == "") continue;
                if (!$.isNumeric(splits[i])) continue;
                if (splits[i].startsWith("0x")) {
                    addresses.push(splits[i]);
                } else {
                    ids.push(splits[i]);
                }
            }
            axies = {};
            addSinglesAxie(ids);
            for (let a in addresses) {
                getAxies(0, addresses[a]);
            }

        } else if ($.isNumeric(text)) {
            axies = {};
            if (text.startsWith("0x")) {
                getAxies(0, [text]);
            } else {
                getAxie(text);
            }
        } else {
            //TODO: do this more elegantly
            alert("invalid search criteria");
        }
    }

    $(document).keyup(function(event) {
        if ($("#search").is(":focus") && event.key == "Enter") {
            search();
        }
    });

    function toggleBinary() {
        if ($('#binaryToggle').is(":checked")) {
            $(".binary").css("display", "none");
        } else {
            $(".binary").css("display", "block");
        }
    }

</script>
    <!-- header -->
    <div id="headerDiv"></div><br/>
    <div id="mainDiv" class="container ml-5">


        <div class="row">
            <div  class="text-left col-6" id="account"></div><br/>
            <input class="text-right col-5 form-control" id="search" size="55" placeholder="ID, address or comma separated list of IDs and/or addresses" />&nbsp;
            <button type="submit" class="btn btn-dark" onclick="search();" id="searchButton0">Search</button>
        </div>
        <div id="loading">Loading...</div>
        <div id="copyDiv"></div>
        <br/>
        <table class="table display nowrap" id="axieTable">
            <thead>
                <tr>
                    <th rowspan="2">ID</th>
                    <th colspan="5">Group 0 (Class, Region, Origin, Misc)</th>
                    <th colspan="7">Group 1 (Pattern and Color)</th>
                    <th colspan="10">Group 2 (Eyes)</th>
                    <th colspan="10">Group 3 (Mouth)</th>
                    <th colspan="10">Group 4 (Ears)</th>
                    <th colspan="10">Group 5 (Horn)</th>
                    <th colspan="10">Group 6 (Back)</th>
                    <th colspan="10">Group 7 (Tail)</th>
                    <th colspan="9">Additional Info</th>
                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
</html>